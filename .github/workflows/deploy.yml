name: üöÄ Deploy ITCAA API

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  predeploy-check:
    name: üîç Predeploy Validation
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v3

      - name: üêç Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: üìÇ Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: üì¶ Install dependencies
        run: pip install -r requirements.txt

      - name: üîç V√©rification installation
        run: pip list

      - name: üß™ Run tests
        run: pytest -v || echo "‚ö†Ô∏è Tests √©chou√©s"

      - name: üéØ Run linting
        run: |
          black --check .
          isort --check-only .
          mypy src || echo "‚ö†Ô∏è Typage incomplet"

      - name: üö® Run predeploy check
        run: python predeploy_check.py

  deploy:
    name: üöÄ Deploy to Render
    needs: predeploy-check
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v3

      - name: üîë Authenticate and trigger Render deploy
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          echo "Authenticating with Render..."
          curl -s -o response.json -w "%{http_code}" \
               -H "Authorization: Bearer $RENDER_API_KEY" \
               -H "Content-Type: application/json" \
               --request POST \
               --data "{\"serviceId\":\"$SERVICE_ID\",\"clearCache\":true}" \
               https://api.render.com/v1/services/$SERVICE_ID/deploys > status_code.txt

          STATUS=$(cat status_code.txt)
          if [ "$STATUS" -ne 200 ]; then
            echo "‚ùå √âchec du d√©ploiement Render (code $STATUS)"
            cat response.json
            exit 1
          else
            echo "‚úÖ D√©ploiement Render d√©clench√© avec succ√®s"
            cat response.json
          fi
