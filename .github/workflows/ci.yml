name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  ## ğŸ” VÃ©rifications CI/CD (Dev checks avec Torch CPU-only)
  ci-install:
    uses: ./.github/workflows/_install.yml
    with:
      env: ci

  lint:
    runs-on: ubuntu-latest
    needs: ci-install
    steps:
      - uses: actions/checkout@v4
      - name: ğŸ¯ Lint
        run: make lint

  typecheck:
    runs-on: ubuntu-latest
    needs: ci-install
    steps:
      - uses: actions/checkout@v4
      - name: ğŸ” Typecheck
        run: make typecheck

  test:
    runs-on: ubuntu-latest
    needs: ci-install
    steps:
      - uses: actions/checkout@v4
      - name: ğŸ§ª Tests
        run: make test

  audit:
    runs-on: ubuntu-latest
    needs: ci-install
    steps:
      - uses: actions/checkout@v4
      - name: ğŸ“Š Audit IA
        run: make audit

  ## ğŸš€ DÃ©ploiement Prod
  prod-install:
    uses: ./.github/workflows/_install.yml
    with:
      env: prod

  build:
    runs-on: ubuntu-latest
    needs: prod-install
    steps:
      - uses: actions/checkout@v4
      - name: ğŸ³ Build Docker
        run: make docker-build

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - name: ğŸš€ Deploy API
        run: |
          make docker-up
          make docker-health