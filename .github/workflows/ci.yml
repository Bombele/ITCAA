name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  ## ğŸ” VÃ©rifications Dev (lint, typecheck, tests, audit IA)
  dev-checks:
    uses: ./.github/workflows/_install.yml
    with:
      env: dev

  lint:
    runs-on: ubuntu-latest
    needs: dev-checks
    steps:
      - uses: actions/checkout@v4
      - name: ğŸ¯ Lint
        run: make lint

  typecheck:
    runs-on: ubuntu-latest
    needs: dev-checks
    steps:
      - uses: actions/checkout@v4
      - name: ğŸ” Typecheck
        run: make typecheck

  test:
    runs-on: ubuntu-latest
    needs: dev-checks
    steps:
      - uses: actions/checkout@v4
      - name: ğŸ§ª Tests
        run: make test

  audit:
    runs-on: ubuntu-latest
    needs: dev-checks
    steps:
      - uses: actions/checkout@v4
      - name: ğŸ“Š Audit IA
        run: make audit

  ## ğŸš€ VÃ©rifications Prod (build, dÃ©ploiement, API)
  prod-deploy:
    uses: ./.github/workflows/_install.yml
    with:
      env: prod

  build:
    runs-on: ubuntu-latest
    needs: prod-deploy
    steps:
      - uses: actions/checkout@v4
      - name: ğŸ³ Build Docker
        run: make docker-build

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - name: ğŸš€ Deploy API
        run: |
          make docker-up
          make docker-health