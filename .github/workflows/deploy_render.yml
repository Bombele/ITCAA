name: ğŸš€ Deploy to Render

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout del repositorio
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v3

      # 2. ConfiguraciÃ³n de Python
      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      # 3. Cache pip
      - name: ğŸ“‚ Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # 4. InstalaciÃ³n de dependencias
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 5. VerificaciÃ³n instalaciÃ³n
      - name: ğŸ” Verify installation
        run: pip list

      # 6. Ejecutar tests antes de desplegar
      - name: ğŸ§ª Run tests
        run: pytest apps/api/tests --maxfail=1 --disable-warnings -q

      # 7. Linting y typage
      - name: ğŸ¯ Lint & type check
        run: |
          black --check .
          isort --check-only .
          mypy src || echo "âš ï¸ Typage incomplet"

      # 8. Deploy en Render
      - name: ğŸš€ Deploy to Render
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          echo "Authenticating with Render..."
          STATUS=$(curl -s -o response.json -w "%{http_code}" \
            -X POST "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys" \
            -H "Authorization: Bearer ${RENDER_API_KEY}" \
            -H "Content-Type: application/json")

          if [ "$STATUS" -ne 200 ]; then
            echo "âŒ Ã‰chec du dÃ©ploiement Render (code $STATUS)"
            cat response.json
            exit 1
          else
            echo "âœ… DÃ©ploiement Render dÃ©clenchÃ© avec succÃ¨s"
            cat response.json
          fi
