name: ğŸ” Predeploy Import Check

on:
  push:
    branches:
      - main
  pull_request:
  schedule:
    - cron: "0 3 * * 1"   # Tous les lundis Ã  03h00 UTC
  workflow_dispatch:       # possibilitÃ© de lancer manuellement

jobs:
  check-imports:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: ğŸ“‚ Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ” Verify installation
        run: pip list

      - name: ğŸš¨ Verify apps module import
        run: |
          export PYTHONPATH=src
          python - << 'EOF'
          import importlib.util, sys
          spec = importlib.util.find_spec("apps")
          if spec is None:
              print("âŒ apps module missing")
              sys.exit(1)
          else:
              print("âœ… apps module found")
          EOF

      - name: ğŸ“ Upload import check logs
        uses: actions/upload-artifact@v3
        with:
          name: predeploy-import-check-logs-${{ github.run_number }}
          path: ./*.log
          if-no-files-found: ignore

      - name: ğŸ§¹ Rotation des rapports (conserver 7 derniers)
        run: |
          mkdir -p public/predeploy_reports
          echo "Predeploy check run ${{ github.run_number }}" > public/predeploy_reports/predeploy_${{ github.run_number }}.log
          ls -t public/predeploy_reports | tail -n +8 | xargs -I {} rm -f public/predeploy_reports/{}
