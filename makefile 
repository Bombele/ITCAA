PYTHONPATH=src
SCRIPT_DIR=scripts
INDEX_REPORT=$(PYTHONPATH)/itcaa_ai_offline/data/index/index_report.md

.PHONY: check repair-index audit install-faiss setup-dev setup-prod verify-scripts generate-scripts

## ðŸ” VÃ©rifie la prÃ©sence des scripts critiques
verify-scripts:
	@echo "ðŸ” VÃ©rification des scripts critiques..."
	@for script in $(SCRIPT_DIR)/repair_index.py $(SCRIPT_DIR)/check_structure.py $(SCRIPT_DIR)/validate_dependencies.py $(SCRIPT_DIR)/validate_render_config.py; do \
		if [ ! -f "$$script" ]; then \
			echo "âŒ Script manquant : $$script"; \
			echo "ðŸ“Œ Conseil : rÃ©gÃ©nÃ©rez les scripts manquants via make generate-scripts"; \
			exit 1; \
		else \
			echo "âœ… Script prÃ©sent : $$script"; \
		fi; \
	done
	@echo "âœ… Tous les scripts critiques sont prÃ©sents."

## ðŸ›  GÃ©nÃ¨re les scripts critiques manquants
generate-scripts:
	@echo "ðŸ›  GÃ©nÃ©ration des scripts critiques manquants..."
	@mkdir -p $(SCRIPT_DIR)
	@for script in repair_index.py check_structure.py validate_dependencies.py validate_render_config.py; do \
		if [ ! -f "$(SCRIPT_DIR)/$$script" ]; then \
			echo "ðŸ“Œ CrÃ©ation de $(SCRIPT_DIR)/$$script"; \
			echo "#!/usr/bin/env python3\n\"\"\"$$script (squelette minimal, Ã  complÃ©ter)\"\"\"\n\nif __name__ == \"__main__\":\n    print(\"âœ… Script $$script gÃ©nÃ©rÃ© (contenu minimal)\")" > $(SCRIPT_DIR)/$$script; \
		else \
			echo "â„¹ï¸ Script dÃ©jÃ  prÃ©sent : $(SCRIPT_DIR)/$$script"; \
		fi; \
	done
	@echo "âœ… Scripts critiques rÃ©gÃ©nÃ©rÃ©s ou confirmÃ©s."

## ðŸ“¦ Installation de FAISS (CPU)
install-faiss:
	@echo "ðŸ“¦ Installation de FAISS (CPU)..."
	pip install "faiss-cpu>=1.8,<1.14"

## ðŸ§  VÃ©rifie la structure du projet IA
check:
	@echo "ðŸ” VÃ©rification structure IA ITCAAâ€¦"
	PYTHONPATH=$(PYTHONPATH) python $(SCRIPT_DIR)/check_structure.py || exit 1

## ðŸ›  VÃ©rifie et rÃ©pare lâ€™index FAISS
repair-index: install-faiss
	@echo "ðŸ›  VÃ©rification et rÃ©paration de lâ€™index FAISSâ€¦"
	PYTHONPATH=$(PYTHONPATH) python $(SCRIPT_DIR)/repair_index.py || exit 1

## ðŸ“Š GÃ©nÃ¨re le rapport d'audit
audit:
	@echo "ðŸ“Š GÃ©nÃ©ration du rapport d'auditâ€¦"
	PYTHONPATH=$(PYTHONPATH) python $(PYTHONPATH)/itcaa_ai_offline/generate_index_report.py || exit 1
	@echo "âœ… Rapport disponible : $(INDEX_REPORT)"

## âš™ï¸ PrÃ©pare lâ€™environnement complet de dÃ©veloppement (minimal)
setup-dev: generate-scripts verify-scripts install-faiss repair-index check audit
	@echo "âœ… Environnement de dÃ©veloppement prÃªt (ai-offline)."

## ðŸš€ PrÃ©pare lâ€™environnement complet de production (minimal)
setup-prod: generate-scripts verify-scripts install-faiss repair-index check
	@echo "âœ… Environnement de production prÃªt (ai-offline)."